<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <title>x-storage test</title>
    <script src="../bower_components/platform/platform.js"></script>
    <link rel="stylesheet" media="all" href="../bower_components/mocha/mocha.css">
    <script src="../bower_components/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <link rel="import" href="../src/element.html">
  </head>
  <body>
    <h1>x-storage test</h1>
    <div id="mocha"><p><a href=".">Index</a></p></div>
    <div id="messages"></div>
    <div id="fixtures"></div>
    <x-storage-indexeddb id="store-nk" name="x-store-no-key-1" index="v i"></x-storage-indexeddb>
    <x-storage-indexeddb id="store-k" name="x-store-key-1" key="k" index="v i"></x-storage-indexeddb>
    <script>
      if (window.mochaPhantomJS) { mochaPhantomJS.run(); }
      else { mocha.run(); }
    </script>
    <script>
      mocha.setup('bdd');
      var kv = document.querySelector('#store-nk');
      var kvk = document.querySelector('#store-k');

      var expect = chai.expect;
      
      var timeout = 5000;
      var n = 200;
      var k = 20;

      var sampleItems = [];
      var sampleIds = [];

      function randomString() {
        return Math.random().toString(36).substr(2);
      }

      function randomNumber() {
        return Math.round(Math.random()*1000000);
      }

      function randomContent() {
        return Math.random() < 0.5 ? randomString() : randomNumber();
      }

      function generateSampleItems(n) {
        var collection = {};
        var items = [];
        while(Object.keys(collection).length < n) {
          key = randomContent();
          collection[key] = randomContent();
        }
        for (var itemKey in collection) {
          var item = {};
          item.k = itemKey;
          item.v = collection[itemKey];
          items.push(item);
        }
        items = shuffleArray(items);
        for (var i = 0; i < items.length; i++) {
          items[i].i = i;
        };
        return items;
      }

      function shuffleArray(o){
          for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
          return o;
      }
      function sortArray(array, property){
        var arr = array.slice(0);
        return arr.sort(function(a,b){
          var a1=typeof a[property], b1=typeof b[property];
          return a1<b1 ? -1 : a1>b1 ? 1 : a[property]<b[property] ? -1 : a[property]>b[property] ? 1 : 0;
        });
      }

      function populateDb(database){
        var array = sampleItems.slice(0);
        var ids = [];
        return database.clear()
          .then(function() {
            return array.reduce(function (prev, cur, i) {
              return prev.then(function(id) {
                if (id) { ids.push(id); }
                return database.save(cur);
              });
            }, Promise.resolve());
          })
          .then(function(lastId){
            ids.push(lastId)
            return Promise.resolve(ids);
          });
      }

      describe("the key value store with key", function(){
        this.timeout(timeout);

        before(function(done){
          sampleItems = generateSampleItems(n);
          singleItem = generateSampleItems(1)[0];
          populateDb(kvk)
            .then(function(){
              done();
            })
        })

        it("should return size() == " + n + "after saving 200 items with save()", function(done){
          kvk.size()
            .then(function(s){expect(s).to.equal(sampleItems.length); done();})
        });
        it("should throw a ConstraintError when you try to save() an existing item", function(done){
          // fails in firefox.. TODO
          kvk.save(sampleItems[0]).then( function(){
          // nothing
          },function(err){
            console.log(err, err.name === "ConstraintError");
            expect(err.name).to.equal("ConstraintError");
            done();
          })
        });
        it("should getAll() all items orderedBy key", function(done){
          var arr = sortArray(sampleItems,"k");
          kvk.getAll()
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              };
              done();
            });
        });
        it("should getAll({'reverse': true}) all items ordered by key reversed", function(done){
          var arr = sortArray(sampleItems,"k");
          arr.reverse();
          kvk.getAll({'reverse': true})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              };
              done(); 
            })
        });
        it("should getAll({'orderby':'v'}) all items orderedBy v", function(done){
          var arr = sortArray(sampleItems,"v");
          kvk.getAll({'orderby':'v'})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              };
              done();
            });
        });
        it("should getAll({'orderby':'v', 'reverse': true}) all items orderedBy v reversed", function(done){
          var arr = sortArray(sampleItems,"v").reverse();
          kvk.getAll({'orderby':'v', 'reverse': true})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              };
              done();
            });
        });

        it("should getMany({count: 5}) 5 items ordered by key", function(done){
          var arr = sortArray(sampleItems,"k");
          kvk.getMany({'count':5})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              }
              done();              
            });
        });
        it("should getMany({count: 5, offset: 50}) 5 items ordered by key order starting after item 5", function(done){
          var arr = sortArray(sampleItems,"k");
          kvk.getMany({'count':5, offset: 50})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+50]);
              }
              done();              
            });
        });
        it("should getMany({count: 5, offset: 25, orderby: v}) 5 items ordered by v order starting after item 25", function(done){
          var arr = sortArray(sampleItems, "v");
          kvk.getMany({'count':5, offset: 25, orderby: "v"})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+25]);
              }
              done();              
            });
        });
        it("should getMany({count: 5, start: <id of item 50>}) 5 items ordered by key starting after item 50", function(done){
          var arr = sortArray(sampleItems,"k");
          kvk.getMany({'count':5, 'start': arr[50].k})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+50]);
              }
              done();
            });
        });
        it("should getMany({start: <id of item 50>, end: <id of item 54>}) 5 items ordered by key starting after item 50", function(done){
          var arr = sortArray(sampleItems,"k");
          kvk.getMany({start: arr[50].k, end: arr[54].k})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+50]);
              }
              done();              
            });
        });
        it("should set(key, obj) an item and get(key) it", function(done){
          var newItem = generateSampleItems(1)[0];
          kvk.set(newItem.k, newItem)
            .then(function(k){ 
              expect(k).to.equal(newItem.k);
              return kvk.get(newItem.k);
            })
            .then(function(item){ 
              expect(item).to.deep.equal(newItem);
              done()
            });
        });
        it("should set(key, obj) an item, update it with set(key, obj) and get(key) it", function(done){
          var newItem = generateSampleItems(1)[0];
          var updatedItem = newItem;
          updatedItem.v = randomContent();

          kvk.set(newItem.k, newItem)
            .then(function(k){ 
              expect(k).to.equal(newItem.k);
              return kvk.get(newItem.k);
            })
            .then(function(item){
              expect(item).to.deep.equal(newItem);
              return kvk.set(newItem.k,updatedItem);
            })
            .then(function(k){
              expect(k).to.equal(newItem.k);
              return kvk.get(newItem.k);
            })
            .then(function(item){
              expect(item).to.deep.equal(updatedItem);
              done();
            });
        });
        it("should set(key,obj) an item, update(key, obj) it item and get(key) it", function(done){
          var newItem = generateSampleItems(1)[0];
          var updatedItem = newItem;
          updatedItem.v = randomContent();

          kvk.set(newItem.k, newItem)
            .then(function(k){ 
              expect(k).to.equal(newItem.k);
              return kvk.get(newItem.k);
            })
            .then(function(item){
              expect(item).to.deep.equal(newItem);
              return kvk.update(newItem.k,updatedItem);
            })
            .then(function(k){
              expect(k).to.equal(newItem.k);
              return kvk.get(newItem.k);
            })
            .then(function(item){
              expect(item).to.deep.equal(updatedItem);
              done();
            });
        });
        it("should throw an Error when you try to update() an non-existant item", function(done){
          // fails in firefox.. TODO
          kvk.update("ttttttt",{k:"ttttttt"}).then( function(){
          // nothing
          },function(err){
            done();
          })
        });
      })

      describe("the key value store without key", function(){
        this.timeout(timeout);

        before(function(done){
          populateDb(kv)
            .then(function(ids){
              sampleIds = ids;
              done();
            })
        })

        it("should return size() == " + n, function(done){
          kv.size()
            .then(function(s){expect(s).to.equal(sampleItems.length); done();})
        });

        it("should getAll() all items orderedBy id", function(done){
          var arr = sampleItems.slice(0);
          kv.getAll()
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              };
              done();
            });
        });
        it("should getAll({'reverse': true}) all items ordered by id reversed", function(done){
          var arr = sampleItems.slice(0);
          arr.reverse();
          kv.getAll({'reverse': true})
            .then(function(all){
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              };
              done(); 
            })
        });
        it("should getMany({count: 5}) 5 items orderedBy id", function(done){
          var arr = sampleItems.slice(0);
          kv.getMany({'count':5})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i]);
              }
              done();              
            });
        });
        it("should getMany({count: 5, offset: 25}) 5 items ordered by id order starting after item 25", function(done){
          var arr = sampleItems.slice(0);
          kv.getMany({'count':5, offset: 25})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+25]);
              }
              done();              
            });
        });
        it("should getMany({count: 5, offset: 25, orderby: v}) 5 items ordered by v order starting after item 25", function(done){
          var arr = sortArray(sampleItems, "v");
          kv.getMany({'count':5, offset: 25, orderby: "v"})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+25]);
              }
              done();              
            });
        });
        it("should getMany({count: 5, start: <id of item 25>}) 5 items ordered by id starting after item 25", function(done){
          var arr = sampleItems.slice(0);
          kv.getMany({'count':5, start: sampleIds[25]})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+25]);
              }
              done();              
            });
        });
        it("should getMany({start: <id of item 25>, end: <id of item 30>}) 5 items ordered by id starting after item 25", function(done){
          var arr = sampleItems.slice(0);
          kv.getMany({start: sampleIds[25], end: sampleIds[29]})
            .then(function(all){
              expect(all.length).to.equal(5);
              for (var i = 0; i < all.length; i++) {
                expect(all[i]).to.deep.equal(arr[i+25]);
              }
              done();              
            });
        });

        // it("should getAll({'orderBy':'value') all items orderedBy value", function(done){
        //   var arr = sortArray(sampleItems,"value");
        //   kv.getAll({'orderBy':'value'})
        //     .then(function(all){
        //       for (var i = 0; i < all.length; i++) {
        //         expect(all[i].key).to.equal(arr[i].key);
        //         expect(all[i].value).to.equal(arr[i].value);
        //       }
        //       done();              
        //     });
        // });
        // it("should getAll({'orderBy':'value', 'reverse': true}) all items orderedBy value reversed", function(done){
        //   var arr = sortArray(sampleItems,"value");
        //   arr.reverse();
        //   kv.getAll({'orderBy':'value', 'reverse':true})
        //     .then(function(all){
        //       for (var i = 0; i < all.length; i++) {
        //         expect(all[i].key).to.equal(arr[i].key);
        //         expect(all[i].value).to.equal(arr[i].value);
        //       }
        //       done();              
        //     });
        // });
        // it("should getAll() all items orderedBy key", function(done){
        //   var arr = sortArray(sampleItems,"key");
        //   kv.getAll()
        //     .then(function(all){
        //       for (var i = 0; i < all.length; i++) {
        //         expect(all[i].key).to.equal(arr[i].key);
        //         expect(all[i].value).to.equal(arr[i].value);
        //       }
        //       done();              
        //     });
        // });
        // it("should getAll() all items orderedBy key, reversed", function(done){
        //   var arr = sortArray(sampleItems,"key");
        //   arr.reverse();
        //   kv.getAll({'reverse': true})
        //     .then(function(all){
        //       for (var i = 0; i < all.length; i++) {
        //         expect(all[i].key).to.equal(arr[i].key);
        //         expect(all[i].value).to.equal(arr[i].value);
        //       }
        //       done();              
        //     });
        // });
        // it("should getRange({count: 5}) 5 items orderedBy key", function(done){
        //   var arr = sortArray(sampleItems,"key");
        //   kv.getRange({'count':5})
        //     .then(function(all){
        //       expect(all.length).to.equal(5);
        //       for (var i = 0; i < all.length; i++) {
        //         expect(all[i].key).to.equal(arr[i].key);
        //         expect(all[i].value).to.equal(arr[i].value);
        //       }
        //       done();              
        //     });
        // });
        // it("should getRange({count: 5, start: key}) 5 items orderedBy key starting with key", function(done){
        //   var arr = sortArray(sampleItems,"key");
        //   var startkey = arr[3].key;
        //   kv.getRange({'count':5,'start':startkey})
        //     .then(function(all){
        //       expect(all.length).to.equal(5);
        //       for (var i = 0; i < all.length; i++) {
        //         expect(all[i].key).to.equal(arr[i+3].key);
        //         expect(all[i].value).to.equal(arr[i+3].value);
        //       }
        //       done();              
        //     });
        // });
        // it("should return size() == " + n + " after updating " + k + " items", function(done){
        //   var promises = [];
        //   for (var i = 0; i < k; i++) {
        //     var key = sampleItems[i].key;
        //     promises.push(kv.set(key,randomContent()));
        //   };
        //   Promise.all(promises)
        //     .then(function(){return kv.size();})
        //     .then(function(s){expect(s).to.equal(n); done();});
        // });
        // it("should set(k,v) and get(k) an item", function(done){
        //   kv.set("theKey","theValue")
        //     .then(function(){ return kv.get("theKey") })
        //     .then(function(i){ expect(i).to.equal("theValue"); done();});
        // });
        // it("should set(k,v) and get(k) an existing item", function(done){
        //   kv.set("theKey","theValue2")
        //     .then(function(){ return kv.get("theKey") })
        //     .then(function(i){ expect(i).to.equal("theValue2"); done();});
        // });
        // it("should be empty again after clear()", function(done){
        //   kv.clear()
        //     .then(function(){return kv.size();})
        //     .then(function(s){expect(s).to.equal(0); done();})
        // });
      })

      document.addEventListener('WebComponentsReady', function(){
        mocha.run();
      }, false);        
    </script>
  </body>
</html>
